---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import VideoEmbed from './VideoEmbed.astro';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// El video que quieres incluir
const featuredVideoUrl = "https://youtu.be/rfPjq-U42Cc";
const featuredVideoTitle = "DeSci Quark Video";

// Formulario de Tally seg√∫n el idioma
// Por ahora usamos el mismo formulario para ambos idiomas, pero puedes reemplazarlo despu√©s
const tallyFormUrl = "https://tally.so/r/mRgoll?transparentBackground=1";
---

<section class="hero-section py-8 md:py-16">
  <div class="container mx-auto px-4 hero-content">
    <div class="flex flex-col lg:flex-row items-center gap-8 lg:gap-12">
      <div class="w-full lg:w-1/2">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-6 animate-fade-in">
          {t('hero.title')}
        </h1>
        <p class="text-blue-100 text-lg mb-8 max-w-xl">
          {t('hero.description')}
        </p>
        <div class="flex flex-col sm:flex-row gap-4">
          <button id="openModalBtn" class="btn btn-primary bg-white text-primary-600 hover:bg-blue-50 shadow-lg">
            {t('hero.registerBtn')}
          </button>
          <a href="#course-content" class="btn btn-outline text-white border-white hover:bg-white hover:text-primary-600 shadow-md">
            {t('hero.learnMoreBtn')}
          </a>
        </div>
      </div>
      <div class="w-full lg:w-1/2 mt-8 lg:mt-0">
        <!-- Contenedor del video -->
        <div class="video-wrapper max-w-[600px] mx-auto">
          <div class="glass-card bg-white/20 border border-white/30 relative overflow-hidden rounded-xl shadow-xl">
            <VideoEmbed url={featuredVideoUrl} title={featuredVideoTitle} />
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal de registro (oculto por defecto) -->
<div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
  <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 relative animate-fade-in shadow-xl h-[600px]">
    <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 z-10">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
    
    <!-- Formulario Tally -->
    <div class="h-full">
      <iframe 
        id="tallyIframe"
        data-tally-src={tallyFormUrl} 
        width="100%" 
        height="100%" 
        frameborder="0" 
        marginheight="0" 
        marginwidth="0" 
        title="üß™ Registro de Testers - DeSci Quark"
        class="w-full h-full">
      </iframe>
    </div>
  </div>
</div>

<script>
  // Modal functionality
  const openModalBtn = document.getElementById('openModalBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const registerModal = document.getElementById('registerModal');
  const tallyIframe = document.getElementById('tallyIframe');

  if (openModalBtn && closeModalBtn && registerModal && tallyIframe) {
    // Cargar el Tally embed script
    function loadTallyScript() {
      // Verificar si el script ya est√° cargado
      if (!document.querySelector('script[src="https://tally.so/widgets/embed.js"]')) {
        const script = document.createElement('script');
        script.src = 'https://tally.so/widgets/embed.js';
        script.async = true;
        document.body.appendChild(script);
      }
    }

    // Inicializar Tally cuando se abre el modal
    function initTally() {
      if (window.Tally) {
        window.Tally.loadEmbeds();
      } else {
        // Si el script a√∫n no se ha cargado, intentar de nuevo en un momento
        setTimeout(initTally, 300);
      }
    }
    
    // Cargar el script de Tally al inicio
    loadTallyScript();
    
    openModalBtn.addEventListener('click', () => {
      registerModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // Inicializar Tally cuando se abre el modal
      setTimeout(initTally, 100);
    });

    closeModalBtn.addEventListener('click', () => {
      registerModal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    });

    // Close modal if clicking outside
    registerModal.addEventListener('click', (e) => {
      if (e.target === registerModal) {
        registerModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
    });
  }
</script>

<style>
  /* Aseguramos que el contenedor del video tenga suficiente espacio */
  .glass-card {
    max-width: 100%;
    margin: 0 auto;
    padding: 0; /* Quitamos el padding para que el video ocupe todo el espacio */
  }
  
  /* Ajustes para el modal de Tally */
  #registerModal .bg-white {
    min-height: 600px;
    max-height: 80vh;
  }
  
  /* Contenedor del video */
  .video-wrapper {
    width: 100%;
  }
</style>
